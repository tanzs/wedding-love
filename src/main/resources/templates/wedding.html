<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wedding...</title>
    <script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.staticfile.org/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --primary: #d43f3a;
            --secondary: #ff9a9e;
            --bg-gradient: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%);
        }

        html, body {
            background: var(--bg-gradient) fixed;
            background-size: cover; margin: 0; padding: 0;
            width: 100%; height: 100%; -webkit-font-smoothing: antialiased;
        }

        [v-cloak] { display: none !important; }
        * { box-sizing: border-box; }

        .glass-card {
            background: rgba(255, 255, 255, 0.78);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 24px;
            padding: 25px 20px; margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        .music-btn {
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.8); display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #fff;
        }
        .rotating { animation: rotate 4s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #quantum-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; background: var(--bg-gradient);
            display: flex; justify-content: center; align-items: center;
        }
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        .enter-card {
            z-index: 10; width: 85%; max-width: 380px; text-align: center;
            padding: 40px 25px; background: rgba(255, 255, 255, 0.3);
            border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.4);
            display: flex; flex-direction: column; align-items: center;
        }

        /* è¡Œç¨‹èŠ‚ç‚¹æ ·å¼ */
        .timeline-node { transition: all 0.5s ease; border-left: 2px dashed #ddd; position: relative; padding-left: 25px; padding-bottom: 25px; margin-left: 10px; }
        .dot { width: 12px; height: 12px; background: #fff; border: 2.5px solid var(--primary); border-radius: 50%; position: absolute; left: -7px; top: 6px; z-index: 2; }

        .status-done { opacity: 0.5; filter: grayscale(0.8); }
        .status-done .dot { background: #ccc !important; border-color: #eee !important; }

        .status-live {
            background: rgba(212, 63, 58, 0.08);
            border-left: 3px solid var(--primary) !important;
            border-radius: 0 15px 15px 0;
            padding-top: 10px; padding-bottom: 10px;
        }
        .status-live .dot {
            background: var(--primary) !important; border-color: #fff !important;
            box-shadow: 0 0 10px var(--primary); animation: pulse-dot 1.5s infinite;
        }
        @keyframes pulse-dot { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }

        .live-tag { background: var(--primary); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; animation: blink 1s infinite alternate; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.4; } }

        .reminder-text { white-space: pre-wrap; font-size: 0.9rem; color: #666; line-height: 1.6; }
        .poster-frame { border: 6px solid #fff; border-radius: 8px; overflow: hidden; background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .poster-img { width: 100%; display: block; object-fit: cover; }

        #main-content { min-height: 100vh; padding: 20px 15px 100px; overflow-y: auto; }
        .nav-btn { background: linear-gradient(90deg, var(--primary), var(--secondary)); color: #fff; padding: 12px 30px; border-radius: 30px; font-weight: bold; border: none; font-size: 1rem; box-shadow: 0 5px 20px rgba(212, 63, 58, 0.2); }

        .action-sheet-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: flex; align-items: flex-end; }
        .action-sheet { width: 100%; background: #fff; border-radius: 24px 24px 0 0; padding: 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); }

        /* æ—¶é—´æ ‡ç­¾æ ·å¼ */
        .time-label { color: var(--primary); font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }
        .time-range-sep { margin: 0 4px; opacity: 0.6; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <div class="music-btn" v-if="!showIntro" @click="toggleMusic" :class="{ rotating: isPlaying }">
        <span style="font-size: 20px;">{{ isPlaying ? 'ğŸµ' : 'ğŸ”‡' }}</span>
    </div>
    <audio ref="bgMusic" loop :src="config?.basic?.backMusic"></audio>

    <div id="quantum-layer" v-if="showIntro" @click="handleEnter">
        <canvas ref="canvasEl"></canvas>
        <div class="enter-card" v-if="config?.basic">
            <div style="font-size: 0.8rem; letter-spacing: 3px; color: var(--primary); margin-bottom: 20px; font-weight: bold;">WELCOME TO OUR WEDDING</div>
            <div style="font-size: 2.4rem; font-weight: 900; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; color: transparent;">
                {{ config.basic.groomName }} & {{ config.basic.brideName }}
            </div>
            <div style="margin: 25px 0; width: 60%; height: 2px; background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), transparent); position: relative;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: var(--primary); background: #fff; padding: 0 8px; font-size: 12px;">â¤</div>
            </div>
            <div style="font-size: 1.2rem; color: #555; letter-spacing: 2px; margin-bottom: 35px; font-weight: 500;">{{ formatDate(config.basic.weddingDate) }}</div>
            <div style="padding: 12px 40px; border-radius: 30px; background: var(--primary); color: #fff; font-weight: bold; box-shadow: 0 5px 20px rgba(212,63,58,0.3);">å¼€å¯å¹¸ç¦æ—¶åˆ»</div>
        </div>
    </div>

    <div id="main-content" v-if="!showIntro && config">
        <div class="glass-card" style="text-align: center;">
            <h1 style="font-size: 2.2rem; margin: 0; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; color: transparent;">
                {{ config.basic?.groomName }} & {{ config.basic?.brideName }}
            </h1>
            <div style="color: #666; font-size: 0.95rem; margin-top: 10px;">
                <p>{{ config.basic?.weddingDate?.replace('T', ' ') }}</p>
                <p>{{ config.basic?.cityName }} Â· {{ config.basic?.weddingLocation }}</p>
            </div>
        </div>

        <div class="glass-card" style="text-align: center;">
            <div v-if="isWeddingDay" style="padding: 10px;">
                <div style="font-size: 1.3rem; color: var(--primary); font-weight: bold; letter-spacing: 2px;">ğŸ‰ ä»Šå¤©æ˜¯æˆ‘ä»¬ç»“å©šçš„æ—¥å­ ğŸ’</div>
                <div style="font-size: 0.9rem; color: #888; margin-top: 8px;">æ„Ÿè°¢æ‚¨åœ¨ç™¾å¿™ä¹‹ä¸­è§è¯æˆ‘ä»¬çš„å¹¸ç¦æ—¶åˆ»</div>
            </div>
            <template v-else-if="countdown.show">
                <div style="color: #888; margin-bottom: 15px; font-size: 0.9rem;">â€”â€” å©šç¤¼å€’è®¡æ—¶ â€”â€”</div>
                <div style="display: flex; justify-content: space-around;">
                    <div v-for="(v, k) in {å¤©:countdown.d, æ—¶:countdown.h, åˆ†:countdown.m, ç§’:countdown.s}" :key="k">
                        <div style="font-size: 1.6rem; font-weight: bold; color: var(--primary);">{{v}}</div>
                        <div style="font-size: 0.75rem; color: #999;">{{k}}</div>
                    </div>
                </div>
            </template>
            <div v-else style="color: var(--primary); font-weight: bold; font-size: 1.1rem;">â¤ï¸ æ„¿çˆ±å¦‚åˆï¼Œæ‰§æ‰‹ç™¾å¹´</div>
        </div>

        <div class="glass-card" v-if="config.basic?.posterUrl" style="padding: 10px;">
            <div class="poster-frame">
                <img :src="config.basic.posterUrl" class="poster-img">
                <div style="padding: 15px; color: var(--primary); font-weight: bold; text-align: center; letter-spacing: 1px;">
                    {{ config.basic?.welcomeDesc }}
                </div>
            </div>
        </div>

        <div class="glass-card">
            <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 1.1rem;">ğŸŒ¸ å©šç¤¼è¡Œç¨‹</h3>
            <div v-for="(node, i) in config.timeline?.timelineNodes" :key="i"
                 :class="['timeline-node', getNodeStatusClass(node, i)]">
                <div class="dot"></div>
                <div>
                    <div class="time-label">
                        <span>{{ node.startTime }}</span>
                        <template v-if="node.endTime">
                            <span class="time-range-sep">-</span>
                            <span>{{ node.endTime }}</span>
                        </template>
                    </div>
                    <div style="font-weight: bold; margin: 3px 0; font-size: 1.05rem; display: flex; align-items: center;">
                        {{ node.title }}
                        <span v-if="getNodeStatusClass(node, i) === 'status-live'" class="live-tag">LIVE</span>
                    </div>
                    <div style="font-size: 0.85rem; color: #7f8c8d;">{{ node.description }}</div>
                </div>
            </div>
        </div>

        <div class="glass-card" v-if="config.basic?.remind" style="border-left: 5px solid var(--secondary);">
            <div style="color: var(--primary); font-weight: bold; font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center;">
                <span style="margin-right: 8px;">âœ‰</span> æ¸©é¦¨æé†’
            </div>
            <div class="reminder-text">{{ config.basic.remind }}</div>
        </div>

        <div class="glass-card" style="text-align: center;">
            <div style="font-size: 1.8rem; margin-bottom: 10px;">ğŸ“</div>
            <div style="font-weight: bold; color: var(--primary); font-size: 1.2rem;">{{ config.basic?.weddingLocation }}</div>
            <div style="font-size: 0.9rem; color: #888; margin: 10px 0 20px;">{{ config.basic?.address }}</div>
            <button class="nav-btn" @click="showMapSelector = true">è·å–åœ°å›¾å¯¼èˆªæŒ‡å¼•</button>
        </div>
    </div>

    <div v-if="showMapSelector" class="action-sheet-mask" @click="showMapSelector = false">
        <div class="action-sheet" @click.stop>
            <div style="padding: 18px; text-align: center; border-bottom: 1px solid #eee; font-size: 1.1rem; color: #333;" @click="openMap('qq')">è…¾è®¯åœ°å›¾</div>
            <div style="padding: 18px; text-align: center; border-bottom: 1px solid #eee; font-size: 1.1rem; color: #333;" @click="openMap('amap')">é«˜å¾·åœ°å›¾</div>
            <div style="padding: 15px; text-align: center; color: #999;" @click="showMapSelector = false">å–æ¶ˆ</div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, reactive, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            const config = ref(null);
            const loading = ref(true);
            const showIntro = ref(true);
            const isPlaying = ref(false);
            const isWeddingDay = ref(false);
            const showMapSelector = ref(false);
            const canvasEl = ref(null);
            const bgMusic = ref(null);
            const countdown = reactive({ show: false, d: '00', h: '00', m: '00', s: '00' });

            const formatDate = (s) => s ? s.split('T')[0].replace(/-/g, ' . ') : '';

            const toggleMusic = () => {
                if (bgMusic.value.paused) { bgMusic.value.play(); isPlaying.value = true; }
                else { bgMusic.value.pause(); isPlaying.value = false; }
            };

            const openMap = (type) => {
                const b = config.value?.basic || {};
                let lng = "121.488585";
                let lat = "31.240801";

                if (b.mapLocation && b.mapLocation.includes(',')) {
                    const parts = b.mapLocation.split(',');
                    lng = parts[0].trim();
                    lat = parts[1].trim();
                }

                const name = encodeURIComponent(b.weddingLocation || "å©šç¤¼åœ°ç‚¹");

                if (type === 'qq') {
                    window.location.href = `https://apis.map.qq.com/uri/v1/geocoder?coord=${lat},${lng}&name=${name}`;
                } else if (type === 'amap') {
                    window.location.href = `https://uri.amap.com/marker?position=${lng},${lat}&name=${name}`;
                }
                showMapSelector.value = false;
            };

            // ğŸŒŸ æ ¸å¿ƒé€»è¾‘ä¼˜åŒ–ï¼šåŒæ—¶æ”¯æŒæ—¶é—´ç‚¹å’Œæ—¶é—´æ®µ
            const getNodeStatusClass = (node, index) => {
                if (!config.value?.basic || !node.startTime) return '';
                const today = config.value.basic.weddingDate.split('T')[0];
                const now = new Date();

                // ç¯èŠ‚å¼€å§‹æ—¶é—´
                const nodeStartTime = new Date(`${today} ${node.startTime}`.replace(/-/g, "/"));

                // ç¯èŠ‚ç»“æŸæ—¶é—´é€»è¾‘ï¼šä¼˜å…ˆå– endTimeï¼Œæ²¡æœ‰åˆ™å–ä¸‹ä¸€èŠ‚ç‚¹å¼€å§‹æ—¶é—´ï¼Œæœ€åå…œåº•3å°æ—¶
                let nodeEndTime;
                if (node.endTime) {
                    nodeEndTime = new Date(`${today} ${node.endTime}`.replace(/-/g, "/"));
                } else {
                    const nextNode = config.value.timeline.timelineNodes[index + 1];
                    if (nextNode) {
                        nodeEndTime = new Date(`${today} ${nextNode.startTime}`.replace(/-/g, "/"));
                    } else {
                        nodeEndTime = new Date(nodeStartTime.getTime() + 3 * 60 * 60 * 1000);
                    }
                }

                if (now > nodeEndTime) return 'status-done';
                if (now >= nodeStartTime && now <= nodeEndTime) return 'status-live';
                return '';
            };

            const fetchData = async () => {
                try {
                    const res = await fetch('/apis/api.wedding.aiym.fun/v1alpha1/config');
                    const data = await res.json();
                    config.value = data;

                    if (data.basic) {
                        document.title = `${data.basic.groomName} â¤ï¸ ${data.basic.brideName}`;

                        const target = new Date(data.basic.weddingDate.replace(/-/g, '/').replace('T', ' ')).getTime();
                        setInterval(() => {
                            const now = Date.now();
                            const dist = target - now;

                            if (dist <= 43200000 && dist > -86400000) {
                                isWeddingDay.value = true;
                                countdown.show = false;
                            } else if (dist > 43200000) {
                                isWeddingDay.value = false;
                                countdown.show = true;
                                countdown.d = Math.floor(dist/86400000).toString().padStart(2,'0');
                                countdown.h = Math.floor((dist%86400000)/3600000).toString().padStart(2,'0');
                                countdown.m = Math.floor((dist%3600000)/60000).toString().padStart(2,'0');
                                countdown.s = Math.floor((dist%60000)/1000).toString().padStart(2,'0');
                            }
                        }, 1000);
                    }
                } catch(e) {
                    console.error("åŠ è½½å¤±è´¥", e);
                } finally {
                    loading.value = false;
                    nextTick(() => initParticles());
                }
            };

            const initParticles = () => {
                const canvas = canvasEl.value; if (!canvas) return;
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                const ctx = canvas.getContext('2d');
                let pts = Array.from({length: 22}, () => ({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: Math.random()-0.5, vy: Math.random()-0.5, size: Math.random()*2+1 }));
                function anim() {
                    if(!showIntro.value) return; ctx.clearRect(0,0,canvas.width,canvas.height);
                    pts.forEach(p => { p.x+=p.vx; p.y+=p.vy; if(p.x<0||p.x>canvas.width) p.vx*=-1; if(p.y<0||p.y>canvas.height) p.vy*=-1; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fillStyle = 'rgba(212, 63, 58, 0.2)'; ctx.fill(); });
                    requestAnimationFrame(anim);
                }
                anim();
            };

            const handleEnter = () => {
                if(bgMusic.value) bgMusic.value.play().then(()=>isPlaying.value=true).catch(()=>{});
                gsap.to('#quantum-layer', { opacity: 0, duration: 0.8, onComplete: () => {
                        showIntro.value = false;
                        document.body.style.overflow = 'auto';
                        nextTick(() => {
                            setTimeout(() => {
                                const live = document.querySelector('.status-live');
                                if (live) live.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }, 500);
                        });
                    }});
            };

            onMounted(fetchData);
            return { loading, showIntro, config, canvasEl, bgMusic, countdown, isPlaying, isWeddingDay, showMapSelector, handleEnter, openMap, formatDate, toggleMusic, getNodeStatusClass };
        }
    }).mount('#app');
</script>
</body>
</html>