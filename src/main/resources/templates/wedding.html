<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wedding Invitation</title>
    <script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.staticfile.org/gsap/3.12.2/gsap.min.js"></script>

    <style>
        /* --- åŸºç¡€è®¾ç½® --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html {
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); /* å¤‡ç”¨èƒŒæ™¯ */
            /* å®é™…èƒŒæ™¯ï¼šæš–æ¡ƒçº¢æ¸å˜ */
            background: linear-gradient(135deg, #fad0c4 0%, #ff9a9e 100%);
            color: #4a4a4a; font-family: -apple-system, "PingFang SC", serif;
            overflow: hidden; -webkit-tap-highlight-color: transparent;
        }

        /* --- Loading --- */
        .loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #fad0c4 0%, #ff9a9e 100%); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.6);
            border-radius: 50%; border-top-color: #d43f3a;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- å¼€åœºå±‚ --- */
        #quantum-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%);
            display: flex; justify-content: center; align-items: center;
        }
        canvas { position: absolute; top: 0; left: 0; mix-blend-mode: screen; }
        .enter-tip { z-index: 10; text-align: center; pointer-events: none; }
        .pulse-text {
            font-size: 1.6rem; letter-spacing: 4px; font-weight: bold;
            background: linear-gradient(90deg, #d43f3a, #ffb347); -webkit-background-clip: text; color: transparent;
            animation: pulse 2s infinite; text-shadow: 0 2px 10px rgba(212,63,58,0.2);
        }
        @keyframes pulse { 0%,100%{opacity:0.8; transform: scale(1);} 50%{opacity:1; transform: scale(1.05);} }

        /* --- ä¸»å†…å®¹ --- */
        #main-content {
            min-height: 100vh; padding: 20px 20px 80px; overflow-y: auto;
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .glass-card {
            background: rgba(255,255,255,0.45); backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.6); border-radius: 24px;
            padding: 25px 20px; margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(212, 63, 58, 0.08);
        }

        /* å¤´éƒ¨ */
        .hero-names h1 {
            font-size: 2.2rem; font-weight: 800; text-align: center; margin-bottom: 10px;
            background: linear-gradient(135deg, #c0392b, #e74c3c); -webkit-background-clip: text; color: transparent;
        }
        .hero-info { text-align: center; color: #7f8c8d; font-size: 0.95rem; line-height: 1.5; }

        /* --- ä¿®å¤ç‰ˆå€’è®¡æ—¶ --- */
        .countdown-box { display: flex; justify-content: space-around; text-align: center; flex-wrap: nowrap; }
        .count-item { display: flex; flex-direction: column; align-items: center; flex: 1; }
        .count-num {
            font-size: 1.6rem; font-weight: bold; color: #c0392b;
            background: rgba(255,255,255,0.6);
            /* å…³é”®ä¿®æ”¹ï¼šå»æ‰å›ºå®šå®½ï¼Œæ”¹ä¸ºæœ€å°å®½+å†…è¾¹è·ï¼Œé˜²æ­¢3ä½æ•°æ¢è¡Œ */
            min-width: 46px; padding: 0 8px; height: 50px;
            line-height: 50px; border-radius: 12px; margin-bottom: 5px;
            box-shadow: 0 4px 10px rgba(192, 57, 43, 0.1);
            font-family: monospace; /* ç­‰å®½å­—ä½“æ•°å­—å¯¹é½æ›´å¥½çœ‹ */
        }
        .count-label { font-size: 0.8rem; color: #888; }

        /* --- æ™ºèƒ½æµç¨‹æ ·å¼ --- */
        .section-title {
            color: #c0392b; margin-bottom: 20px; font-size: 1.2rem; font-weight: bold;
            display: flex; align-items: center;
        }
        .section-title::before { content: 'â™¥'; margin-right: 8px; color: #e74c3c; }

        .timeline-box { position: relative; padding-left: 10px; }

        .timeline-item {
            display: flex; padding-bottom: 30px;
            border-left: 2px dashed rgba(192, 57, 43, 0.2);
            margin-left: 8px; padding-left: 25px; position: relative;
            transition: all 0.3s;
        }
        .timeline-item:last-child { border-left: 2px solid transparent; }

        /* çŠ¶æ€ï¼šåœ†ç‚¹åŸºç¡€æ ·å¼ */
        .time-dot {
            width: 16px; height: 16px; border-radius: 50%;
            position: absolute; left: -9px; top: 4px;
            background: #fff; border: 3px solid #ccc; /* é»˜è®¤ç°è‰² */
            z-index: 2; transition: all 0.3s;
        }

        /* çŠ¶æ€ 1ï¼šå·²ç»“æŸ (Done) */
        .status-done .time-dot {
            background: #ccc; border-color: #ccc;
            display: flex; align-items: center; justify-content: center;
        }
        .status-done .time-dot::after {
            content: 'âœ”'; font-size: 10px; color: #fff;
        }
        .status-done .time-content { opacity: 0.6; filter: grayscale(0.8); }

        /* çŠ¶æ€ 2ï¼šè¿›è¡Œä¸­ (Active) */
        .status-active .time-dot {
            background: #d43f3a; border-color: #fff;
            box-shadow: 0 0 0 3px rgba(212, 63, 58, 0.3);
            animation: pulse-dot 1.5s infinite;
        }
        @keyframes pulse-dot { 0% { box-shadow: 0 0 0 0 rgba(212, 63, 58, 0.6); } 70% { box-shadow: 0 0 0 8px rgba(212, 63, 58, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 63, 58, 0); } }

        .status-active .time-title { color: #d43f3a !important; font-size: 1.15rem; }
        .live-tag {
            display: inline-block; background: #d43f3a; color: #fff;
            font-size: 0.7rem; padding: 1px 6px; border-radius: 4px;
            margin-left: 8px; vertical-align: middle;
            animation: blink 1s infinite alternate;
        }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.6; } }

        /* çŠ¶æ€ 3ï¼šå¾…è¿›è¡Œ (Todo) -> é»˜è®¤æ ·å¼ */
        .status-todo .time-dot { border-color: #e74c3c; background: #fff; }

        /* æ–‡æœ¬æ ·å¼ */
        .time-start { color: #c0392b; font-weight: bold; font-size: 1rem; margin-bottom: 2px; }
        .time-title { font-size: 1.1rem; font-weight: bold; color: #333; margin-bottom: 4px; }
        .time-desc { font-size: 0.85rem; color: #7f8c8d; }

        /* åº•éƒ¨å¯¼èˆª */
        .nav-btn {
            margin-top: 15px; background: linear-gradient(90deg, #c0392b, #e74c3c);
            color: #fff; display: inline-block; padding: 10px 28px; border-radius: 30px;
            font-size: 1rem; box-shadow: 0 4px 15px rgba(192, 57, 43, 0.3);
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="app">
    <audio ref="bgMusic" loop>
        <source src="https://music.163.com/song/media/outer/url?id=1457707525.mp3" type="audio/mpeg">
    </audio>

    <div class="loading-mask" v-if="loading">
        <div class="spinner"></div>
        <div>é…ç½®å©šç¤¼ç°åœºä¸­...</div>
    </div>

    <div id="quantum-layer" v-if="!loading && showIntro" @click="handleEnter">
        <canvas ref="canvasEl"></canvas>
        <div class="enter-tip">
            <div class="pulse-text">ç‚¹å‡»å¼€å¯ å¹¸ç¦æ—¶åˆ»</div>
            <div style="margin-top:15px; color:#c0392b; font-weight:bold; opacity:0.8;" v-if="config?.basic">
                {{ config.basic.groomName }} â¤ {{ config.basic.brideName }}
            </div>
        </div>
    </div>

    <div id="main-content" v-if="!showIntro && config">
        <div class="glass-card hero-names">
            <h1>{{ config.basic?.groomName }} & {{ config.basic?.brideName }}</h1>
            <div class="hero-info">
                <p>{{ config.basic?.weddingDate }}</p>
                <p style="margin-top:5px;">{{ config.basic?.cityName }} Â· {{ config.basic?.weddingLocation }}</p>
            </div>
        </div>

        <div class="glass-card" v-if="countdown.show">
            <div class="section-title" style="justify-content:center; margin-bottom:15px; color:#555; font-size:1rem;">
                è·ç¦»å©šç¤¼è¿˜æœ‰
            </div>
            <div class="countdown-box">
                <div class="count-item"><div class="count-num">{{countdown.d}}</div><div class="count-label">å¤©</div></div>
                <div class="count-item"><div class="count-num">{{countdown.h}}</div><div class="count-label">æ—¶</div></div>
                <div class="count-item"><div class="count-num">{{countdown.m}}</div><div class="count-label">åˆ†</div></div>
                <div class="count-item"><div class="count-num">{{countdown.s}}</div><div class="count-label">ç§’</div></div>
            </div>
        </div>

        <div class="glass-card">
            <h3 class="section-title">å©šç¤¼æµç¨‹</h3>
            <div class="timeline-box">
                <div v-for="(node, i) in config.timeline?.timelineNodes" :key="i"
                     class="timeline-item"
                     :class="getNodeStatusClass(node)">

                    <div class="time-dot"></div>

                    <div class="time-content">
                        <div class="time-start">{{ node.startTime }}</div>
                        <div class="time-title">
                            {{ node.title }}
                            <span v-if="getNodeStatusClass(node) === 'status-active'" class="live-tag">LIVE</span>
                        </div>
                        <div class="time-desc">{{ node.description }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card" @click="openNavigation" style="text-align:center; padding-bottom: 30px;">
            <div style="font-size:3.5rem; margin-bottom:5px;">ğŸ“</div>
            <div style="font-weight:bold; font-size:1.2rem; margin-bottom:5px;">{{ config.basic?.weddingLocation }}</div>
            <div style="font-size:0.9rem; color:#7f8c8d;">{{ config.basic?.address || 'æœŸå¾…æ‚¨çš„å…‰ä¸´' }}</div>
            <div class="nav-btn">ä¸€é”®å¯¼èˆªå‰å¾€</div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, reactive, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            const config = ref(null);
            const loading = ref(true);
            const showIntro = ref(true);
            const canvasEl = ref(null);
            const bgMusic = ref(null);

            // å€’è®¡æ—¶
            const countdown = reactive({ show: false, d: '00', h: '00', m: '00', s: '00' });
            let timerInterval = null;

            // --- çŠ¶æ€åˆ¤æ–­æ ¸å¿ƒé€»è¾‘ ---
            const getNodeStatusClass = (node) => {
                if (!config.value || !config.value.basic || !node.startTime) return 'status-todo';

                // 1. è·å–å©šç¤¼æ—¥æœŸ (YYYY-MM-DD)
                // å…¼å®¹ "2025-10-01" æˆ– "2025-10-01 12:00"
                const dateStr = config.value.basic.weddingDate.split(' ')[0];

                // 2. æ‹¼æ¥å½“å‰èŠ‚ç‚¹çš„å®Œæ•´æ—¶é—´å¯¹è±¡
                // æ³¨æ„å…¼å®¹ iOS (YYYY/MM/DD)
                const nodeTimeStr = `${dateStr} ${node.startTime}`.replace(/-/g, "/");
                const nodeDate = new Date(nodeTimeStr);
                const now = new Date();

                // 3. æ—¶é—´å¯¹æ¯”é€»è¾‘
                const diff = now - nodeDate; // æ¯«ç§’å·®

                // A. å¦‚æœèŠ‚ç‚¹æ—¶é—´æ¯”ç°åœ¨æ—©è¶…è¿‡ 1å°æ—¶ (3600000ms)ï¼Œè®¤ä¸ºå·²ç»“æŸ
                // (ä½ å¯ä»¥è°ƒæ•´è¿™ä¸ª 1å°æ—¶ï¼Œæ¯”å¦‚æ”¹ä¸º 30åˆ†é’Ÿ)
                if (diff > 3600000) {
                    return 'status-done';
                }

                // B. å¦‚æœèŠ‚ç‚¹æ—¶é—´åœ¨è¿‡å»ï¼Œä½†è¿˜æ²¡è¶…è¿‡1å°æ—¶ -> æ­£åœ¨è¿›è¡Œä¸­
                // æˆ–è€… èŠ‚ç‚¹æ—¶é—´æ˜¯æœªæ¥ï¼Œä½†åœ¨30åˆ†é’Ÿå†… (å³å°†å¼€å§‹) -> ä¹Ÿç®— Active
                // è¿™é‡Œæˆ‘ä»¬ç®€å•ç‚¹ï¼šè¿‡å»1å°æ—¶å†… = è¿›è¡Œä¸­
                if (diff >= 0 && diff <= 3600000) {
                    return 'status-active';
                }

                // C. å¦åˆ™æ˜¯æœªæ¥ -> å¾…è¿›è¡Œ
                return 'status-todo';
            };

            const startCountdown = (dateStr) => {
                if (!dateStr) return;
                const targetTime = new Date(dateStr.replace(/-/g, "/")).getTime();

                timerInterval = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = targetTime - now;
                    if (distance < 0) {
                        clearInterval(timerInterval);
                        countdown.show = false;
                        return;
                    }
                    countdown.show = true;
                    // è®¡ç®—å¤©æ•°
                    countdown.d = Math.floor(distance / (1000 * 60 * 60 * 24)).toString(); // ä¸è¡¥0ï¼Œé˜²æ­¢3ä½æ•°æ˜¾ç¤ºä¸è‡ªç„¶
                    if (countdown.d.length < 2) countdown.d = '0' + countdown.d; // åªæœ‰å°äº10æ‰è¡¥0

                    countdown.h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
                    countdown.m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
                    countdown.s = Math.floor((distance % (1000 * 60)) / 1000).toString().padStart(2, '0');
                }, 1000);
            };

            const fetchData = async () => {
                try {
                    const res = await fetch('/apis/api.wedding.aiym.fun/v1alpha1/config');
                    const data = await res.json();
                    config.value = data;

                    if (data.basic?.weddingDate) {
                        startCountdown(data.basic.weddingDate);
                    }

                    loading.value = false;
                    nextTick(() => initParticles());
                } catch (e) {
                    console.error("Fetch Error:", e);
                    // å…œåº•æ•°æ®
                    config.value = {
                        basic: {
                            groomName: "æ–°éƒ", brideName: "æ–°å¨˜",
                            weddingDate: "2025-10-01 12:00", weddingLocation: "å©šç¤¼ç°åœº",
                            mapLocation: "113.695495,26.646221"
                        },
                        timeline: { timelineNodes: [
                                {startTime:'09:00', title:'æ¥äº²', description:'å‰å¾€æ–°å¨˜å®¶'},
                                {startTime:'12:00', title:'ä»ªå¼', description:'å©šç¤¼æ­£å¼å¼€å§‹'}
                            ]}
                    };
                    loading.value = false;
                    nextTick(() => initParticles());
                }
            };

            const initParticles = () => {
                const canvas = canvasEl.value;
                if (!canvas) return;
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                const ctx = canvas.getContext('2d');
                let particles = Array.from({length: 60}, () => ({
                    x: canvas.width/2, y: canvas.height/2,
                    vx: (Math.random()-0.5)*6, vy: (Math.random()-0.5)*6,
                    color: ['#e74c3c', '#f39c12', '#ffffff'][Math.floor(Math.random()*3)],
                    size: Math.random()*3+1
                }));
                function animate() {
                    if(!showIntro.value) return;
                    ctx.fillStyle = 'rgba(255, 200, 200, 0.1)';
                    ctx.fillRect(0,0,canvas.width,canvas.height);
                    particles.forEach(p => {
                        p.x += p.vx; p.y += p.vy;
                        if(p.x<0||p.x>canvas.width) p.vx*=-1;
                        if(p.y<0||p.y>canvas.height) p.vy*=-1;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                        ctx.fillStyle = p.color; ctx.fill();
                    });
                    requestAnimationFrame(animate);
                }
                animate();
            };

            const handleEnter = () => {
                if(bgMusic.value) bgMusic.value.play().catch(()=>{});
                document.body.style.overflow = 'auto';
                if (typeof gsap !== 'undefined') {
                    gsap.to('#quantum-layer', {
                        opacity: 0, duration: 0.8, onComplete: () => { showIntro.value = false; }
                    });
                } else {
                    showIntro.value = false;
                }
            };

            const openNavigation = () => {
                const loc = config.value?.basic?.mapLocation || "113.695495,26.646221";
                const parts = loc.split(',');
                window.location.href = `https://uri.amap.com/marker?position=${parts[0]},${parts[1]}&name=å©šç¤¼ç°åœº`;
            };

            onMounted(() => fetchData());

            return { loading, showIntro, config, canvasEl, bgMusic, countdown, getNodeStatusClass, handleEnter, openNavigation };
        }
    }).mount('#app');
</script>
</body>
</html>